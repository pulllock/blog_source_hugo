---
title: JVM中对象的栈上分配
date: 2017-08-21 14:30:45
categories: 
- JVM
tags:
- JVM
---

JVM中的栈上分配学习

<!--more-->

# 栈上分配

JVM中对象除了在堆上分配之外，还提供了一项称为栈上分配的优化技术。JVM利用逃逸分析技术来分析一个对象的作用域是否仅限于方法内部，也就是对象是否属于线程私有，如果作用域仅限于方法内部，则可以直接在栈帧上进行对象分配。

对象分配在栈上，而不是堆上，对象可以在方法调用结束后销毁，不需要垃圾收集器进行垃圾收集，提高性能。

栈上分配依赖逃逸分析，逃逸分析可以判断对象的作用域是否有可能逃逸出方法。适用于作用域范围为方法内部的，也就是方法逃逸。如果能逃逸出方法或者线程的对象，则不能适用栈上分配。

JVM在Server模式下，才可以启用逃逸分析，有关参数：

- `-server` Server模式
- `-XX:+DoEscapeAnalysis` 启用逃逸分析
- `-XX:+EliminateAllocations` 开启标量替换，默认就是打开的

# 标量替换

- 标量是指一个数据无法再分解成更小的数据类型，比如原始数据类型以及referencce类型。
- 聚合量是指可以继续分解的数据，比如Java中的对象。

把一个Java对象拆散，根据程序访问情况，将用到的成员变量变成原始类型来访问，这个过程就是标量替换。

如果逃逸分析表明一个对象不会逃逸到方法外，并且这个对象可以被拆散，程序执行的时候就有可能不去创建这个对象，而是直接创建使用到的成员变量，可以让成员变量在栈上分配和读写，栈上的数据有很大机会被虚拟机分配到物理机高速寄存器中存储。

# 参考

- 《实战Java虚拟机 JVM故障诊断与性能优化》
- 《HotSpot实战》
- 《深入理解Java虚拟机：JVM高级特性与最佳实践》