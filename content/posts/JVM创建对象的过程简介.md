---
title: JVM创建对象的过程简介
date: 2017-06-01 23:45:51
categories: 
- JVM
tags:
- JVM
---
记录一下JVM创建对象的过程，就是new一个对象的时候发生了哪些事情。

<!--more-->

Java中对象的创建就是在堆上分配内存空间的过程，此处说的对象创建仅限于new关键字创建的普通Java对象，不包括数组对象的创建。

大致过程如下：

1. 检测类是否被加载
2. 为对象分配内存
3. 为分配的内存空间初始化零值
4. 对对象进行其他设置
5. 执行init方法

# 检测类是否被加载

当虚拟机执行到new字节码指令时（new字节码指令详细信息可以参考虚拟机规范），会根据new字节码指令的参数去常量池中查找这个类的符号引用，并检查该类是否已经被加载。如果类没有被加载过，就会使用类加载器执行类的加载过程。类加载过程可以参考：JVM类加载机制

# 为对象分配内存

类加载完成以后，虚拟机就开始为对象分配内存，此时所需内存的大小就已经确定了。只需要在堆上分配所需要的内存即可。

分配内存的步骤：

- 先尝试栈上分配
- 如果栈上分配失败，则尝试TLAB分配
- 如果TLAB分配失败，则在堆上分配（先看是否满足直接进入老年代，如果满足则直接进入老年代，如果不满足则在eden分配）

在堆中分配内存有两种策略：

第一种情况是内存空间绝对规整，第二种情况是内存空间是不连续的。

* 一种情况是内存空间绝对规整，虚拟机只需要在被占用的内存和可用空间之间移动指针即可，这种方式被称为指针碰撞。

* 另外一种情况是内存空间是不连续的，这时候虚拟机需要维护一个列表，来记录哪些内存是可用的。分配内存的时候需要找到一个可用的内存空间，然后在列表上记录下已被分配，这种方式成为空闲列表。

堆上分配内存的时候也需要考虑线程安全问题和效率问题，有两种解决方案：

* 如果在公共的堆上分配对象，则需要进行同步保证线程安全，虚拟机采用CAS加失败重试的方式保证更新操作原子性。
* 另外一种方法是使用TLAB，每个线程在堆上都有自己的一块单独内存，分配对象就在自己的内存区域内，线程之间无影响。

# 为分配的内存空间初始化零值

对象的内存分配完成后，还需要将对象的内存空间都初始化为零值，这样能保证对象即使没有赋初值，也可以直接使用。

# 对对象进行其他设置

分配完内存空间，初始化零值之后，虚拟机还需要对对象进行其他必要的设置，设置的地方都在对象头中，包括这个对象所属的类，类的元数据信息，对象的hashcode，GC分代年龄等信息。

# 执行init方法

执行完上面的步骤之后，在虚拟机里这个对象就算创建成功了，但是对于Java程序来说还需要执行init方法才算真正的创建完成，因为这个时候对象只是被初始化零值了，还没有真正的去根据程序中的代码分配初始值，调用了init方法之后，这个对象才真正能使用。

到此为止一个对象就产生了，这就是new关键字创建对象的过程。过程如下：

```
检测类是否被加载 --> 为对象分配内存空间 --> 初始零值 --> 进行必要的设置 --> 调用init方法进行初始化。
```

# drawio画的图

使用drawio画了一张图，这里是源文件：[JVM类加载机制](/JVM创建对象的过程简介/JVM类加载机制.drawio)

![JVM类加载机制](/JVM创建对象的过程简介/JVM类加载机制.png)

# 参考

- 《实战Java虚拟机 JVM故障诊断与性能优化》
- 《HotSpot实战》
- 《深入理解Java虚拟机：JVM高级特性与最佳实践》