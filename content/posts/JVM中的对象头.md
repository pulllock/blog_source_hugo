---
title: JVM中的对象头
date: 2017-07-30 21:14:17
categories: 
- JVM
tags:
- JVM
---

JVM中的对象和对象头学习。

<!--more-->

Hotspot虚拟机对象在堆内存中可划分为三部分：

- 对象头Header
- 实例数据Instance Data
- 对齐填充Padding

# 对象头

32位Hotspot虚拟机的对象头：

![Hotspot虚拟机对象头](/JVM中的对象头/Hotspot虚拟机对象头.png)

图片来自《深入理解Java虚拟机》

对象头也叫Mark Word，包括两类信息：

- 第一部分：用于存储对象自身的运行时数据
- 第二部分：是类型指针，对象指向它的类型元数据的指针

## 存储对象自身的运行时数据

对象头第一部分是用来存储对象自身的运行时数据，包括：哈希码、GC分代年龄、锁状态标志、线程持有的锁、偏向线程ID、偏向时间戳等。这部分长度在32位和64位虚拟机分别是32bit和64bit，不同状态下存储的内容不同：

- 无锁状态：25位存储对象的哈希码，4位存储对象分代年龄，1位固定为0，2位用来存储锁标志位01
- 轻量级锁：30位指向调用栈中锁记录的指针，2位用来存储锁标志位00
- 重量级锁：30位指向重量级锁的指针，2位用来存储锁标志位10
- GC标记：30位为空，2位用来存储锁标志位11
- 可偏向锁：23位偏向线程ID，2位偏向时间戳，4位对象分代年龄，1位固定为1，2位用来存储锁标志01

## 类型指针

类型指针是对象指向它的类型元数据的指针，通过这个指针来确定对象是哪个类的实例。如果对象是数组，对象头还有一块用来记录数组长度的数据

# 实例数据

实例数据存储的就是我们程序代码里定义的各种类型的字段内容，从父类继承下来的、自己定义的字段都必须记录起来。

# 对齐填充

Hotspot要求对象起始地址必须是8字节的整数倍，如果对象实例数据没有对齐的话，需要用填充来补全对齐。

# 参考

- 《实战Java虚拟机 JVM故障诊断与性能优化》
- 《HotSpot实战》
- 《深入理解Java虚拟机：JVM高级特性与最佳实践》